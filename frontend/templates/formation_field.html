{% extends 'base.html' %}
{% load static %}

{% block title %}Formation Analysis - Chelsea FC Digital Twin{% endblock %}

{% block extra_css %}
<style>
    .formation-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .formation-header {
        background: linear-gradient(135deg, #1f4e79 0%, #3d85c6 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 2rem;
    }

    .formation-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .formation-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .formation-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .formation-selector {
        background: white;
        border: 2px solid #1f4e79;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: #1f4e79;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .formation-selector:hover,
    .formation-selector.active {
        background: #1f4e79;
        color: white;
    }

    .field-container {
        background: linear-gradient(to bottom, #2e7d2e 0%, #1e5c1e 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        min-height: 600px;
    }

    .field-lines {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    .field-line {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
    }

    .field-line.horizontal {
        height: 2px;
        left: 10%;
        right: 10%;
    }

    .field-line.vertical {
        width: 2px;
        top: 10%;
        bottom: 10%;
    }

    .field-line.center-line {
        top: 50%;
        transform: translateY(-50%);
    }

    .field-line.left-line {
        left: 10%;
    }

    .field-line.right-line {
        right: 10%;
    }

    .field-line.top-line {
        top: 10%;
    }

    .field-line.bottom-line {
        bottom: 10%;
    }

    .center-circle {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 120px;
        height: 120px;
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .penalty-area {
        position: absolute;
        border: 2px solid rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.05);
    }

    .penalty-area.top {
        top: 10%;
        left: 35%;
        width: 30%;
        height: 15%;
    }

    .penalty-area.bottom {
        bottom: 10%;
        left: 35%;
        width: 30%;
        height: 15%;
    }

    .formation-grid {
        position: relative;
        height: 500px;
        margin: 2rem 0;
    }

    .formation-row {
        position: absolute;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 2rem;
    }

    .formation-row.goalkeepers {
        bottom: 5%;
    }

    .formation-row.defenders {
        bottom: 25%;
    }

    .formation-row.midfielders {
        bottom: 50%;
    }

    .formation-row.forwards {
        top: 25%;
    }

    .player-card {
        background: white;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border: 3px solid #1f4e79;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .player-card:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    .player-number {
        font-size: 1.2rem;
        font-weight: bold;
        color: #1f4e79;
    }

    .player-name {
        font-size: 0.7rem;
        font-weight: 600;
        color: #1f4e79;
        text-align: center;
        line-height: 1;
        margin-top: 2px;
    }

    .player-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 4px;
    }

    .substitutes-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-top: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .substitutes-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        color: #1f4e79;
    }

    .substitutes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .substitute-group {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }

    .substitute-group-title {
        font-weight: 600;
        color: #1f4e79;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .substitute-player {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: white;
        border-radius: 6px;
        border-left: 3px solid #1f4e79;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .substitute-player:hover {
        background: #e3f2fd;
        transform: translateX(5px);
    }

    .substitute-number {
        background: #1f4e79;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .substitute-info {
        flex: 1;
    }

    .substitute-name {
        font-weight: 600;
        color: #343a40;
        font-size: 0.9rem;
    }

    .substitute-position {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .formation-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #1f4e79;
    }

    .stat-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        color: #1f4e79;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f4e79;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 300px;
        color: white;
        font-size: 1.2rem;
    }

    .loading-spinner i {
        margin-right: 0.5rem;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .formation-container {
            padding: 1rem;
        }

        .formation-title {
            font-size: 2rem;
        }

        .player-card {
            width: 60px;
            height: 60px;
        }

        .player-number {
            font-size: 1rem;
        }

        .player-name {
            font-size: 0.6rem;
        }

        .formation-row {
            gap: 1rem;
        }

        .substitutes-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="formation-container">
    <!-- Formation Header -->
    <div class="formation-header">
        <h1 class="formation-title">Tactical Formation</h1>
        <p class="formation-subtitle">Chelsea FC Strategic Setup & Player Positioning</p>
    </div>

    <!-- Formation Controls -->
    <div class="formation-controls">
        <button class="formation-selector active" data-formation="433" onclick="loadFormation('433')">
            <i class="fas fa-chess-board"></i>
            4-3-3
        </button>
        <button class="formation-selector" data-formation="352" onclick="loadFormation('352')">
            <i class="fas fa-chess-board"></i>
            3-5-2
        </button>
        <button class="formation-selector" data-formation="442" onclick="loadFormation('442')">
            <i class="fas fa-chess-board"></i>
            4-4-2
        </button>
        <button class="formation-selector" data-formation="4231" onclick="loadFormation('4231')">
            <i class="fas fa-chess-board"></i>
            4-2-3-1
        </button>
    </div>

    <!-- Football Field -->
    <div class="field-container">
        <!-- Field Lines -->
        <div class="field-lines">
            <div class="field-line horizontal top-line"></div>
            <div class="field-line horizontal center-line"></div>
            <div class="field-line horizontal bottom-line"></div>
            <div class="field-line vertical left-line"></div>
            <div class="field-line vertical right-line"></div>
        </div>

        <!-- Center Circle -->
        <div class="center-circle"></div>

        <!-- Penalty Areas -->
        <div class="penalty-area top"></div>
        <div class="penalty-area bottom"></div>

        <!-- Formation Grid -->
        <div class="formation-grid" id="formationGrid">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                Loading formation data...
            </div>
        </div>
    </div>

    <!-- Substitutes Section -->
    <div class="substitutes-section">
        <div class="substitutes-header">
            <i class="fas fa-users"></i>
            <h3>Substitutes & Squad</h3>
            <span id="substituteCount" class="badge badge-secondary">Loading...</span>
        </div>
        <div class="substitutes-grid" id="substitutesGrid">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                Loading substitutes...
            </div>
        </div>
    </div>

    <!-- Formation Statistics -->
    <div class="formation-stats">
        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-users"></i>
                <h4>Squad Status</h4>
            </div>
            <div class="stat-value" id="totalPlayers">--</div>
            <div class="stat-label">Total Players</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-running"></i>
                <h4>Available</h4>
            </div>
            <div class="stat-value" id="availablePlayers">--</div>
            <div class="stat-label">Ready to Play</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-medical"></i>
                <h4>Injured</h4>
            </div>
            <div class="stat-value" id="injuredPlayers">--</div>
            <div class="stat-label">Out of Action</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-chart-line"></i>
                <h4>Formation Win Rate</h4>
            </div>
            <div class="stat-value" id="formationWinRate">--%</div>
            <div class="stat-label">Success Rate</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentFormation = '433';
    let formationData = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadFormation('433');
    });

    async function loadFormation(formation) {
        currentFormation = formation;
        updateFormationSelector(formation);

        try {
            showLoading('Loading formation...');

            const response = await fetch(`/api/formation-${formation}/`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            formationData = data.formation;

            displayFormation(formationData);
            displaySubstitutes(formationData.substitutes);
            updateFormationStats(formationData);

            hideLoading();
        } catch (error) {
            console.error('Error loading formation:', error);
            showToast('Failed to load formation data', 'error');
            hideLoading();
        }
    }

    function updateFormationSelector(formation) {
        document.querySelectorAll('.formation-selector').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-formation="${formation}"]`).classList.add('active');
    }

    function displayFormation(formation) {
        const grid = document.getElementById('formationGrid');
        grid.innerHTML = '';

        // Create formation rows
        const positions = ['forwards', 'midfielders', 'defenders', 'goalkeepers'];

        positions.forEach(position => {
            const players = position === 'goalkeepers' ? [formation.starting.goalkeeper] : formation.starting[position];

            if (players && players.length > 0) {
                const row = document.createElement('div');
                row.className = `formation-row ${position}`;

                players.forEach(player => {
                    if (player) {
                        const playerCard = createPlayerCard(player, true);
                        row.appendChild(playerCard);
                    }
                });

                grid.appendChild(row);
            }
        });
    }

    function displaySubstitutes(substitutes) {
        const grid = document.getElementById('substitutesGrid');
        grid.innerHTML = '';

        const positions = ['goalkeepers', 'defenders', 'midfielders', 'forwards'];
        let totalSubs = 0;

        positions.forEach(position => {
            const players = substitutes[position];

            if (players && players.length > 0) {
                totalSubs += players.length;

                const group = document.createElement('div');
                group.className = 'substitute-group';

                const title = document.createElement('div');
                title.className = 'substitute-group-title';
                title.textContent = position.charAt(0).toUpperCase() + position.slice(1);
                group.appendChild(title);

                players.forEach(player => {
                    const playerElement = createSubstitutePlayer(player);
                    group.appendChild(playerElement);
                });

                grid.appendChild(group);
            }
        });

        document.getElementById('substituteCount').textContent = `${totalSubs} Available`;
    }

    function createPlayerCard(player, isStarter = false) {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.onclick = () => showPlayerInfo(player);

        // Try to use player photo, fallback to generated avatar
        const photoElement = player.photo && !player.photo.includes('placeholder')
            ? `<img src="${player.photo}" alt="${player.name}" class="player-avatar" onerror="this.style.display='none'">`
            : '';

        card.innerHTML = `
            ${photoElement}
            <div class="player-number">${player.number || '?'}</div>
            <div class="player-name">${player.name.split(' ').pop()}</div>
        `;

        return card;
    }

    function createSubstitutePlayer(player) {
        const element = document.createElement('div');
        element.className = 'substitute-player';
        element.onclick = () => showPlayerInfo(player);

        element.innerHTML = `
            <div class="substitute-number">${player.number || '?'}</div>
            <div class="substitute-info">
                <div class="substitute-name">${player.name}</div>
                <div class="substitute-position">${player.role || player.position}</div>
            </div>
        `;

        return element;
    }

    function updateFormationStats(formation) {
        const starting = formation.starting;
        const substitutes = formation.substitutes;

        // Calculate totals
        const startingCount = 1 + starting.defenders.length + starting.midfielders.length + starting.forwards.length;
        const subsCount = substitutes.goalkeepers.length + substitutes.defenders.length +
                         substitutes.midfielders.length + substitutes.forwards.length;
        const totalPlayers = startingCount + subsCount;

        // Count injured (for demo, assume 0-2 random injuries)
        const injuredCount = Math.floor(Math.random() * 3);
        const availableCount = totalPlayers - injuredCount;

        // Mock win rate based on formation
        const winRates = { '433': 68, '352': 72, '442': 65, '4231': 70 };
        const winRate = winRates[currentFormation] || 65;

        document.getElementById('totalPlayers').textContent = totalPlayers;
        document.getElementById('availablePlayers').textContent = availableCount;
        document.getElementById('injuredPlayers').textContent = injuredCount;
        document.getElementById('formationWinRate').textContent = winRate;
    }

    function showPlayerInfo(player) {
        const info = `
            <strong>${player.name}</strong><br>
            Position: ${player.role || player.position}<br>
            Number: ${player.number || 'N/A'}<br>
            Age: ${player.age || 'N/A'}<br>
            Nationality: ${player.nationality || 'N/A'}
        `;

        showToast(info, 'info', 5000);
    }

    // Utility functions (assuming they exist in main.js)
    function showLoading(message) {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.querySelector('p').textContent = message;
            overlay.style.display = 'flex';
        }
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = message;

        const container = document.getElementById('toastContainer');
        if (container) {
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, duration);
        } else {
            alert(message.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
        }
    }
</script>
{% endblock %}